{#
================================================================================
DASHBOARD - Main Overview Page
================================================================================
Purpose: Display system statistics, recent activities, and pending requests
Extends: base.html
Features: Statistics cards, recent patients/activities tables, owner-specific sections
Access: All authenticated users (some sections owner-only)
================================================================================
#}
{% extends "base.html" %}

{% block title %}Dashboard - Dental Clinic{% endblock %}

{% block content %}
<!-- Page Header with Pending Requests Button (owner only) -->
<div class="dashboard-header d-flex align-items-center mb-4">
  <h2 class="mb-0 text-pink"><i class="bi bi-speedometer2"></i> Dashboard</h2>

  <!-- Pending Requests Button: Only visible to owners -->
  {% if current_user.is_owner() %}
  <a href="{{ url_for('pending_requests_view') }}" class="btn btn-outline-danger position-relative ms-3">
    <i class="bi bi-exclamation-triangle"></i> Pending Requests
    <!-- Badge showing count of pending deletion requests -->
    {% if total_pending_count > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      {{ total_pending_count }}
      <span class="visually-hidden">pending deletion requests</span>
    </span>
    {% endif %}
  </a>
  {% endif %}
</div>

<div class="container-fluid dashboard-container">
  <!-- Statistics Cards Row -->
  <div class="row mb-4">
    <!-- Total Patients Card (clickable, navigates to patients list) -->
    <div class="col-md-3">
      <a href="{{ url_for('patients') }}" class="text-decoration-none">
        <div class="card bg-pink text-white shadow card-clickable">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase mb-1">Total Patients</h6>
                <h2 class="mb-0">{{ total_patients }}</h2>
              </div>
              <div>
                <i class="bi bi-people display-4"></i>
              </div>
            </div>
          </div>
        </div>
      </a>
    </div>

    <!-- Staff Members Card (owner only, clickable) -->
    {% if current_user.is_owner() %}
    <div class="col-md-3">
      <a href="{{ url_for('staff') }}" class="text-decoration-none">
        <div class="card bg-dark-pink text-white shadow card-clickable">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-uppercase mb-1">Staff Members</h6>
                <h2 class="mb-0">{{ total_staff }}</h2>
              </div>
              <div>
                <i class="bi bi-person-badge display-4"></i>
              </div>
            </div>
          </div>
        </div>
      </a>
    </div>
    {% endif %}

    <!-- Current User Role Card (non-clickable, informational) -->
    <div class="col-md-3">
      <div class="card bg-accent-pink text-white shadow">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-uppercase mb-1">Your Role</h6>
              <h4 class="mb-0">{{ current_user.role|upper }}</h4>
            </div>
            <div>
              <i class="bi bi-award display-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending Deletion Requests Section (owner only, top 3 recent requests) -->
  {% if current_user.is_owner() and pending_requests %}
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-triangle"></i> Recent Pending Deletion Requests</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Patient Name</th>
                  <th>Requested By</th>
                  <th>Requested At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Loop through pending deletion requests -->
                {% for request in pending_requests %}
                <tr>
                  <td>{{ request['first_name'] }} {{ request['last_name'] }}</td>
                  <td>{{ request['requested_by_name'] }}</td>
                  <td><small>{{ request['requested_at'] }}</small></td>
                  <td>
                    <!-- Approve Form -->
                    <form action="{{ url_for('approve_request', request_id=request['id']) }}" method="POST" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-success btn-sm" type="submit">Approve</button>
                    </form>
                    <!-- Deny Form -->
                    <form action="{{ url_for('deny_request', request_id=request['id']) }}" method="POST" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-danger btn-sm" type="submit">Deny</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <!-- Link to view all pending requests if more than 3 exist -->
            {% if total_pending_count > 3 %}
            <div class="text-end">
              <a href="{{ url_for('pending_requests_view') }}" class="btn btn-sm btn-outline-danger">View All Pending Requests</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Two-Column Layout: Recent Activities + Recent Patients -->
  <div class="row mt-4">
    <!-- Recent Activities Table (left column) -->
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activities</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Action</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody>
                <!-- Loop through recent audit log activities (last 5) -->
                {% for activity in recent_activities %}
                <tr>
                  <td>{{ activity.username }}</td>
                  <td><span class="badge bg-secondary">{{ activity.action }}</span></td>
                  <td><small>{{ activity.timestamp }}</small></td>
                </tr>
                {% else %}
                <!-- Show message if no activities found -->
                <tr>
                  <td colspan="3" class="text-center text-muted">No recent activities</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Patients Table (right column) -->
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-person-plus"></i> Recent Patients</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Added</th>
                </tr>
              </thead>
              <tbody>
                <!-- Loop through recently added patients (last 5) -->
                {% for patient in recent_patients %}
                <tr>
                  <td>{{ patient.first_name }} {{ patient.last_name }}</td>
                  <td>{{ patient.phone }}</td>
                  <td><small>{{ patient.created_at }}</small></td>
                </tr>
                {% else %}
                <!-- Show message if no patients found -->
                <tr>
                  <td colspan="3" class="text-center text-muted">No patients yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
